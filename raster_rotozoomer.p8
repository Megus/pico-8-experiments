pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- PICO-8 init function, we create a coroutine here
function _init()
  cfx = cocreate(fx)
end

-- We want our effect to run in 60 FPS,
-- so we use _update60() instead of _update()
function _update60()
end

-- PICO-8 frame draw function
function _draw()
  memset(0x6000, 0, 0x2000)
  coresume(cfx)
  -- Uncomment the following lines to see CPU load
  cursor(0, 0)
  color(15)
  print(stat(1))
end

-- Raster bars + roto-zoomer
function fx()
  -- Raster bars variables
  local ph1, ph2, ph3 = 0, 0, 0
  local pht1, pht2, pht3, x
  -- Roto-zoomer variables
  local zph, zzoom, zpx, zpy = 0, 1, 0, 0
  local xr, lx, hx, ztx, zty, zdx, zdy, zsx, zsy

  while true do
    -- Clear the line buffer
    memset(0x7fc0, 0, 0x40)
    -- Raster bars temporary variables
    pht1, pht2, pht3 = ph1, ph2, ph3
    -- Roto-zoomer temporary variables
    lx = 64
    hx = 0
    zdx = cos(zph) * (1 + sin(zzoom) * 0.5)
    zdy = sin(zph) * (1 + sin(zzoom) * 0.5)
    zsx = sin(zpx) * 20
    zsy = sin(zpy) * 20

    for i = 0, 127 do
      -- Vertical raster bars
      x = flr(63 + sin(pht1) * 19 + sin(pht2) * 9 + sin(pht3) * 7)
      pset(x - 1, 127, 0)
      pset(x, 127, 5)
      pset(x + 1, 127, 13)
      pset(x + 2, 127, 13)
      pset(x + 3, 127, 5)
      pht1 += 0.01
      pht2 += 0.02
      pht3 += 0.04

      -- Roto-zoomer
      xr = flr(x / 2)
      if (xr < lx) lx = xr
      if (xr + 2 > hx) hx = xr + 2
      ztx = zsx + i / 2 * zdy
      zty = zsy + i / 2 * zdx
      -- Left part
      for c = 0, lx - 1 do
        poke(0x7fc0 + c, (band(bxor(zty, ztx), 8) == 8) and 0xaa or 0)
        ztx += zdx
        zty -= zdy
      end

      ztx += zdx * (hx - lx + 1)
      zty -= zdy * (hx - lx + 1)

      -- Right part
      for c = hx + 1, 63 do
        poke(0x7fc0 + c, (band(bxor(zty, ztx), 8) == 8) and 0xaa or 0)
        ztx += zdx
        zty -= zdy
      end

      -- Clean some artifacts
      if pget(x + 4, 127) == 10 then pset(x + 4, 127, 0) end
      if pget(x + 5, 127) == 10 then pset(x + 5, 127, 0) end

      -- Copy line
      memcpy(0x6000 + i * 64, 0x7fc0, 0x40)
    end

    -- Update raster bars variables
    ph1 += 0.002
    ph2 += 0.004
    ph3 += 0.03

    -- Update roto-zoomer variables
    zph += 0.001
    zpx += 0.002
    zpy += 0.003
    zzoom += 0.001

    yield()
  end
end

-- Raster bars only
function fx_raster()
  -- Raster bars variables
  local ph1, ph2, ph3 = 0, 0, 0
  local pht1, pht2, pht3, x

  while true do
    -- Clear the line buffer
    memset(0x7fc0, 0, 0x40)
    -- Raster bars temporary variables
    pht1, pht2, pht3 = ph1, ph2, ph3

    for i = 0, 127 do
      -- Vertical raster bars
      x = flr(63 + sin(pht1) * 19 + sin(pht2) * 9 + sin(pht3) * 7)
      pset(x - 1, 127, 0)
      pset(x, 127, 5)
      pset(x + 1, 127, 13)
      pset(x + 2, 127, 13)
      pset(x + 3, 127, 5)
      pht1 += 0.01
      pht2 += 0.02
      pht3 += 0.04

      -- Copy line
      memcpy(0x6000 + i * 64, 0x7fc0, 0x40)
    end

    -- Update raster bars variables
    ph1 += 0.002
    ph2 += 0.004
    ph3 += 0.03

    yield()
  end
end

__gfx__
00000000aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaaaaaa1111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101020102020102010201020102010201020102000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202010201010201020102010201020102010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101020102020102010201020102010201020102000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202010201010201020102010201020102010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010201020102010201020102010201020102000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020102010201020102010201020102010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010201020102010201020102010201020102000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020102010201020102010201020102010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010201020102010201020102010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020102010201020102010201020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010201020102010201020102010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020102010201020102010201020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
011000000c7750c535182750c375184750c1750c235183750c4750c735181750c375185750c7750c335187750c2750c235181750c775184750c3750c735181750c7750c235187750c375185750c4750c33518275
01100000180761b0761f06622066180561b0561f04622046180361b0361f02622026180161b0161f0162201613500165000c5000f50013500165000c5000f50013500165000c5000f50000000000000000000000
01100000180761b0761f06621066180561b0561f04621046180361b0361f02621026180161b0161f0162101600000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000000c7750c535182750c375184750c1750c235183750c4750c735181750c375185750c7750c335187750c2750c235181750c775184750c3750c735181750c7750c235187750c375185750c4750c33518275
011000001897018970189701897018970189701897018970189701897018970189701897018970189701897018a7018a7018a7018a7018a7018a7018a7018a7018a7018a7018a7018a7018a7018a7018a7018a70
__music__
01 08094344
02 08424344

